name: Build, Tag & Release Docker Image

on:
  push:
    branches:
      - main

permissions:
  contents: write       # needed to create tags and GitHub Releases
  packages: write       # needed to push to GHCR

jobs:
  # ──────────────────────────────────────────────
  # 1. Derive a CalVer-style tag  (YYYY.MM.DD-<run_number>)
  # ──────────────────────────────────────────────
  tag:
    name: Create Git Tag
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.set_tag.outputs.new_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Generate tag name
        id: set_tag
        run: |
          TAG="$(date -u +'%Y.%m.%d')-${{ github.run_number }}"
          echo "new_tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Tag will be: $TAG"

      - name: Push tag
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "${{ steps.set_tag.outputs.new_tag }}"
          git push origin "${{ steps.set_tag.outputs.new_tag }}"

  # ──────────────────────────────────────────────
  # 2. Build & push Docker images for both archs
  #    (builds run in parallel to save time)
  # ──────────────────────────────────────────────
  build:
    name: Build image (${{ matrix.target_arch }})
    runs-on: ubuntu-latest
    needs: tag
    strategy:
      fail-fast: false
      matrix:
        target_arch:
          - x86_64-linux
          - aarch64-linux
    env:
      REGISTRY: ghcr.io
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Lowercase image name
        id: image
        run: echo "name=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_OUTPUT"

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # qemu is required for cross-arch builds inside Docker
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Normalize the NixOS arch to a Docker-friendly suffix
      # x86_64-linux → amd64   aarch64-linux → arm64
      - name: Derive Docker arch suffix
        id: arch
        run: |
          ARCH="${{ matrix.target_arch }}"
          case "$ARCH" in
            x86_64-linux)   SUFFIX="amd64"  ;;
            aarch64-linux)  SUFFIX="arm64"  ;;
            *)              SUFFIX="$ARCH"  ;;
          esac
          echo "suffix=$SUFFIX" >> "$GITHUB_OUTPUT"

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          build-args: |
            TARGET_ARCH=${{ matrix.target_arch }}
          tags: |
            ${{ env.REGISTRY }}/${{ steps.image.outputs.name }}:${{ needs.tag.outputs.new_tag }}-${{ steps.arch.outputs.suffix }}
            ${{ env.REGISTRY }}/${{ steps.image.outputs.name }}:latest-${{ steps.arch.outputs.suffix }}

  # ──────────────────────────────────────────────
  # 3. Create a GitHub Release with useful notes
  # ──────────────────────────────────────────────
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [tag, build]
    env:
      REGISTRY: ghcr.io
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Lowercase image name
        id: image
        run: echo "name=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_OUTPUT"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.tag.outputs.new_tag }}
          name: "Release ${{ needs.tag.outputs.new_tag }}"
          body: |
            ## NixOS Swarm Node ISO Builder — ${{ needs.tag.outputs.new_tag }}

            Pre-built Docker images are available on GitHub Container Registry:

            | Architecture | Pull command |
            |---|---|
            | `x86_64-linux`  | `docker pull ${{ env.REGISTRY }}/${{ steps.image.outputs.name }}:${{ needs.tag.outputs.new_tag }}-amd64` |
            | `aarch64-linux` | `docker pull ${{ env.REGISTRY }}/${{ steps.image.outputs.name }}:${{ needs.tag.outputs.new_tag }}-arm64` |

            ### Usage
            ```bash
            # x86_64 ISO
            docker run --rm \
              -v "$(pwd)/out:/out" \
              ${{ env.REGISTRY }}/${{ steps.image.outputs.name }}:${{ needs.tag.outputs.new_tag }}-amd64 \
              <MANAGER_IP> <SWARM_TOKEN> [TARGET_DISK]

            # aarch64 ISO
            docker run --rm \
              -v "$(pwd)/out:/out" \
              ${{ env.REGISTRY }}/${{ steps.image.outputs.name }}:${{ needs.tag.outputs.new_tag }}-arm64 \
              <MANAGER_IP> <SWARM_TOKEN> [TARGET_DISK]
            ```
          generate_release_notes: true
